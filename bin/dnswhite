#!/usr/bin/env bash

SITE_TO_ALLOW="${1}"

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
# shellcheck source=/dev/null
source "${SCRIPT_DIR}/include"

if [[ ! -d "${CYGNUS_CONFIG_DIR}" ]]; then
    mkdir -p "${CYGNUS_CONFIG_DIR}"
fi

ALLOWREGEX4H="${BLACKHOLE_IP4_REGEX} ${SITE_TO_ALLOW}$"
ALLOWREGEX6H="${BLACKHOLE_IP6_REGEX} ${SITE_TO_ALLOW}$"
ALLOWREGEX4D="address=/${SITE_TO_ALLOW}/${BLACKHOLE_IP4_REGEX}$"
ALLOWREGEX6D="address=/${SITE_TO_ALLOW}/${BLACKHOLE_IP6_REGEX} $"

#test000007.ru

echo "Matching hosts:"
grep -E "${ALLOWREGEX4H}" "${BLACKHOSTSLIST}"
grep -E "${ALLOWREGEX6H}" "${BLACKHOSTSLIST}"
echo ""
echo "Matching domains:"
grep -E "${ALLOWREGEX4D}" "${BLACKDOMSLIST}"
grep -E "${ALLOWREGEX6D}" "${BLACKDOMSLIST}"

exit 1

# Remove from sites blacklist
TMP_FILE4=$(mktemp /tmp/dnswhite.4.XXXXXX)
TMP_FILE6=$(mktemp /tmp/dnswhite.6.XXXXXX)
grep -vE "${ALLOWREGEX4H}" "${BLACKHOSTSLIST}" > "${TMP_FILE4}"
grep -vE "${ALLOWREGEX6H}" "${TMP_FILE4}" > "${TMP_FILE6}"
sudo mv "${TMP_FILE6}" "${BLACKHOSTSLIST}"
sudo rm "${TMP_FILE4}"
sudo chmod 744 "${BLACKHOSTSLIST}"
sudo chown root:wheel "${BLACKHOSTSLIST}"

# Remove from domains blocklist
TMP_FILE4=$(mktemp /tmp/dnswhite.4.XXXXXX)
TMP_FILE6=$(mktemp /tmp/dnswhite.6.XXXXXX)
grep -vE "${ALLOWREGEX4D}" "${BLACKDOMSLIST}" > "${TMP_FILE4}"
grep -vE "${ALLOWREGEX6D}" "${TMP_FILE4}" > "${TMP_FILE6}"
sudo mv "${TMP_FILE6}" "${BLACKDOMSLIST}"
sudo rm "${TMP_FILE4}"
sudo chmod 744 "${BLACKDOMSLIST}"
sudo chown root:wheel "${BLACKDOMSLIST}"

# Remember this site
echo "${SITE_TO_ALLOW}" >> "${CYGNUS_CONFIG_DIR}/white.list"

sudo pluginctl dns
